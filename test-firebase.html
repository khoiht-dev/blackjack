<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        #log {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>ðŸ”¥ Firebase Connection Test</h1>
    
    <div>
        <button onclick="testFirebaseInit()">1. Test Firebase Init</button>
        <button onclick="testFirestoreConnection()">2. Test Firestore Connection</button>
        <button onclick="testCreateDocument()">3. Test Create Document</button>
        <button onclick="testReadDocument()">4. Test Read Document</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div id="log"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Credentials -->
    <script src="firebase-credentials.js"></script>

    <script>
        const logEl = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            logEl.innerHTML = '';
        }

        // Test 1: Firebase Init
        function testFirebaseInit() {
            log('=== Test 1: Firebase Initialization ===', 'info');
            
            try {
                if (typeof firebase === 'undefined') {
                    log('âŒ Firebase SDK khÃ´ng Ä‘Æ°á»£c load!', 'error');
                    log('Kiá»ƒm tra káº¿t ná»‘i internet vÃ  Firebase CDN', 'error');
                    return;
                }
                log('âœ… Firebase SDK Ä‘Ã£ load', 'success');

                if (typeof window.FIREBASE_CREDENTIALS === 'undefined') {
                    log('âŒ FIREBASE_CREDENTIALS khÃ´ng tÃ¬m tháº¥y!', 'error');
                    log('Kiá»ƒm tra file firebase-credentials.js', 'error');
                    return;
                }
                log('âœ… FIREBASE_CREDENTIALS Ä‘Ã£ load', 'success');
                log('Config: ' + JSON.stringify(window.FIREBASE_CREDENTIALS, null, 2), 'info');

                if (!firebase.apps.length) {
                    firebase.initializeApp(window.FIREBASE_CREDENTIALS);
                    log('âœ… Firebase Ä‘Ã£ khá»Ÿi táº¡o thÃ nh cÃ´ng!', 'success');
                } else {
                    log('âœ… Firebase Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o trÆ°á»›c Ä‘Ã³', 'success');
                }

                window.db = firebase.firestore();
                log('âœ… Firestore Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o', 'success');
                log('', 'info');
                log('ðŸ‘‰ Tiáº¿p theo: Click "2. Test Firestore Connection"', 'info');

            } catch (error) {
                log('âŒ Lá»—i: ' + error.message, 'error');
                log('Stack: ' + error.stack, 'error');
            }
        }

        // Test 2: Firestore Connection
        async function testFirestoreConnection() {
            log('=== Test 2: Firestore Connection ===', 'info');
            
            try {
                if (!window.db) {
                    log('âŒ Firestore chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o! Cháº¡y Test 1 trÆ°á»›c.', 'error');
                    return;
                }

                log('Äang kiá»ƒm tra káº¿t ná»‘i Firestore...', 'info');
                
                // Thá»­ Ä‘á»c má»™t collection
                const snapshot = await db.collection('_test_connection').limit(1).get();
                log('âœ… Káº¿t ná»‘i Firestore thÃ nh cÃ´ng!', 'success');
                log('Sá»‘ documents tÃ¬m tháº¥y: ' + snapshot.size, 'info');
                log('', 'info');
                log('ðŸ‘‰ Tiáº¿p theo: Click "3. Test Create Document"', 'info');

            } catch (error) {
                log('âŒ Lá»—i káº¿t ná»‘i Firestore: ' + error.message, 'error');
                log('Code: ' + error.code, 'error');
                
                if (error.code === 'permission-denied') {
                    log('', 'error');
                    log('ðŸ”’ Lá»–I PERMISSION DENIED!', 'error');
                    log('NguyÃªn nhÃ¢n: Firestore Security Rules cháº·n truy cáº­p', 'error');
                    log('', 'error');
                    log('Giáº£i phÃ¡p:', 'info');
                    log('1. Truy cáº­p: https://console.firebase.google.com/', 'info');
                    log('2. Chá»n project: blackjack-36f3d', 'info');
                    log('3. VÃ o Firestore Database', 'info');
                    log('4. Tab "Rules"', 'info');
                    log('5. Thay Ä‘á»•i rules thÃ nh:', 'info');
                    log('', 'info');
                    log('rules_version = \'2\';', 'info');
                    log('service cloud.firestore {', 'info');
                    log('  match /databases/{database}/documents {', 'info');
                    log('    match /{document=**} {', 'info');
                    log('      allow read, write: if true;', 'info');
                    log('    }', 'info');
                    log('  }', 'info');
                    log('}', 'info');
                    log('', 'info');
                    log('6. Click "Publish"', 'info');
                } else if (error.message.includes('Missing or insufficient permissions')) {
                    log('', 'error');
                    log('Firestore Database cÃ³ thá»ƒ chÆ°a Ä‘Æ°á»£c táº¡o!', 'error');
                    log('HÃ£y táº¡o Firestore Database trong Firebase Console', 'error');
                } else {
                    log('Stack: ' + error.stack, 'error');
                }
            }
        }

        // Test 3: Create Document
        async function testCreateDocument() {
            log('=== Test 3: Create Document ===', 'info');
            
            try {
                if (!window.db) {
                    log('âŒ Firestore chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o! Cháº¡y Test 1 trÆ°á»›c.', 'error');
                    return;
                }

                const testId = 'TEST_' + Date.now();
                log('Äang táº¡o test document vá»›i ID: ' + testId, 'info');

                const testData = {
                    message: 'Hello from Blackjack Game!',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    testId: testId
                };

                await db.collection('_test_rooms').doc(testId).set(testData);
                log('âœ… Táº¡o document thÃ nh cÃ´ng!', 'success');
                log('Data: ' + JSON.stringify(testData, null, 2), 'info');
                log('', 'info');
                log('ðŸ‘‰ Tiáº¿p theo: Click "4. Test Read Document"', 'info');

                // LÆ°u testId Ä‘á»ƒ test Ä‘á»c
                window.lastTestId = testId;

            } catch (error) {
                log('âŒ Lá»—i táº¡o document: ' + error.message, 'error');
                log('Code: ' + error.code, 'error');
                log('Stack: ' + error.stack, 'error');
            }
        }

        // Test 4: Read Document
        async function testReadDocument() {
            log('=== Test 4: Read Document ===', 'info');
            
            try {
                if (!window.db) {
                    log('âŒ Firestore chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o! Cháº¡y Test 1 trÆ°á»›c.', 'error');
                    return;
                }

                if (!window.lastTestId) {
                    log('âŒ ChÆ°a cÃ³ test document! Cháº¡y Test 3 trÆ°á»›c.', 'error');
                    return;
                }

                log('Äang Ä‘á»c test document: ' + window.lastTestId, 'info');

                const doc = await db.collection('_test_rooms').doc(window.lastTestId).get();
                
                if (doc.exists) {
                    log('âœ… Äá»c document thÃ nh cÃ´ng!', 'success');
                    log('Data: ' + JSON.stringify(doc.data(), null, 2), 'info');
                    log('', 'info');
                    log('ðŸŽ‰ Táº¤T Cáº¢ TESTS Äá»€U PASS!', 'success');
                    log('Firebase vÃ  Firestore hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng.', 'success');
                    log('', 'info');
                    log('BÃ¢y giá» báº¡n cÃ³ thá»ƒ chÆ¡i game Blackjack!', 'success');
                } else {
                    log('âŒ Document khÃ´ng tá»“n táº¡i!', 'error');
                }

            } catch (error) {
                log('âŒ Lá»—i Ä‘á»c document: ' + error.message, 'error');
                log('Code: ' + error.code, 'error');
                log('Stack: ' + error.stack, 'error');
            }
        }

        // Auto-run Test 1 khi load trang
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('ðŸš€ Tá»± Ä‘á»™ng cháº¡y Test 1...', 'info');
                testFirebaseInit();
            }, 500);
        });
    </script>
</body>
</html>
